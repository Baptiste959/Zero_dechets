<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Participer Ã  une mission â€“ ZÃ©ro DÃ©chets en Rade</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="Participer.css" />

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
  </head>

  <body>
    <!-- HEADER -->
    <header class="header">
      <div class="logo">ZÃ©ro DÃ©chets en Rade</div>
      <nav>
        <a href="index.html">Accueil</a>
        <a href="Missions.html">Missions</a>
        <a href="communaute.html">CommunautÃ©</a>
      </nav>
      <a href="Participer.html" class="btn">Participer</a>
    </header>

    <div class="container">
      <div class="page-header">
        <h1>Participer Ã  une mission de nettoyage</h1>
        <p>Choisissez une mission existante ou crÃ©ez un nouvel Ã©vÃ©nement</p>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="join">
          ğŸ“‹ Rejoindre une mission
        </button>
        <button class="tab-btn" data-tab="create">â• CrÃ©er un Ã©vÃ©nement</button>
      </div>

      <!-- Tab: Rejoindre une mission -->
      <div class="tab-content active" id="join-tab">
        <div class="content-grid">
          <!-- Liste des Ã©vÃ©nements -->
          <div class="events-section">
            <h2>ğŸ“ Missions disponibles</h2>

            <div
              class="event-card"
              data-lieu="Plage du Moulin Blanc"
              data-date="12/02/2026"
              data-signalements="5"
            >
              <div class="event-header">
                <div class="event-title">Plage du Moulin Blanc</div>
                <span class="urgence-badge green">Faible</span>
              </div>
              <div class="event-info">
                <div>ğŸ“… Mercredi 12 fÃ©vrier 2026 - 14h00</div>
                <div>ğŸš¨ 5 signalements</div>
                <div>ğŸ‘¥ 8 participants inscrits</div>
              </div>
            </div>

            <div
              class="event-card"
              data-lieu="Plage Sainte-Anne du Portzic"
              data-date="13/02/2026"
              data-signalements="8"
            >
              <div class="event-header">
                <div class="event-title">Plage Sainte-Anne du Portzic</div>
                <span class="urgence-badge green">Faible</span>
              </div>
              <div class="event-info">
                <div>ğŸ“… Jeudi 13 fÃ©vrier 2026 - 15h30</div>
                <div>ğŸš¨ 8 signalements</div>
                <div>ğŸ‘¥ 12 participants inscrits</div>
              </div>
            </div>

            <div
              class="event-card"
              data-lieu="Plage du Douvez"
              data-date="14/02/2026"
              data-signalements="12"
            >
              <div class="event-header">
                <div class="event-title">Plage du Douvez</div>
                <span class="urgence-badge orange">ModÃ©rÃ©</span>
              </div>
              <div class="event-info">
                <div>ğŸ“… Vendredi 14 fÃ©vrier 2026 - 10h00</div>
                <div>ğŸš¨ 12 signalements</div>
                <div>ğŸ‘¥ 15 participants inscrits</div>
              </div>
            </div>

            <div
              class="event-card"
              data-lieu="Plage du Passage"
              data-date="15/02/2026"
              data-signalements="9"
            >
              <div class="event-header">
                <div class="event-title">Plage du Passage</div>
                <span class="urgence-badge green">Faible</span>
              </div>
              <div class="event-info">
                <div>ğŸ“… Samedi 15 fÃ©vrier 2026 - 09h00</div>
                <div>ğŸš¨ 9 signalements</div>
                <div>ğŸ‘¥ 20 participants inscrits</div>
              </div>
            </div>

            <div
              class="event-card"
              data-lieu="Plage du Corbeau"
              data-date="19/02/2026"
              data-signalements="16"
            >
              <div class="event-header">
                <div class="event-title">Plage du Corbeau</div>
                <span class="urgence-badge orange">ModÃ©rÃ©</span>
              </div>
              <div class="event-info">
                <div>ğŸ“… Mercredi 19 fÃ©vrier 2026 - 14h00</div>
                <div>ğŸš¨ 16 signalements</div>
                <div>ğŸ‘¥ 18 participants inscrits</div>
              </div>
            </div>

            <div
              class="event-card"
              data-lieu="Plage du Dellec"
              data-date="17/02/2026"
              data-signalements="23"
            >
              <div class="event-header">
                <div class="event-title">Plage du Dellec</div>
                <span class="urgence-badge red">Urgent</span>
              </div>
              <div class="event-info">
                <div>ğŸ“… Lundi 17 fÃ©vrier 2026 - 10h00</div>
                <div>ğŸš¨ 23 signalements</div>
                <div>ğŸ‘¥ 25 participants inscrits</div>
              </div>
            </div>
          </div>

          <!-- Formulaire d'inscription -->
          <div class="form-section">
            <h2>âœï¸ Inscription</h2>

            <div class="info-box">
              âš ï¸ Veuillez sÃ©lectionner une mission dans la liste pour vous
              inscrire
            </div>

            <div class="selected-event-display" id="selectedEventDisplay">
              <strong>Mission sÃ©lectionnÃ©e :</strong>
              <div id="selectedEventText"></div>
            </div>

            <form id="participationForm">
              <div class="form-group">
                <label for="nom"
                  >Nom complet <span class="required">*</span></label
                >
                <input
                  type="text"
                  id="nom"
                  name="nom"
                  required
                  placeholder="Jean Dupont"
                />
              </div>

              <div class="form-group">
                <label for="email">Email <span class="required">*</span></label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  placeholder="jean.dupont@example.com"
                />
              </div>

              <div class="form-group">
                <label for="telephone"
                  >TÃ©lÃ©phone <span class="required">*</span></label
                >
                <input
                  type="tel"
                  id="telephone"
                  name="telephone"
                  required
                  placeholder="06 12 34 56 78"
                />
              </div>

              <div class="form-group">
                <label for="participants">Nombre de participants</label>
                <select id="participants" name="participants">
                  <option value="1">1 personne</option>
                  <option value="2">2 personnes</option>
                  <option value="3">3 personnes</option>
                  <option value="4">4 personnes</option>
                  <option value="5+">Plus de 5 personnes</option>
                </select>
              </div>

              <div class="form-group">
                <label for="message">Message (optionnel)</label>
                <textarea
                  id="message"
                  name="message"
                  placeholder="Questions, besoins particuliers..."
                ></textarea>
              </div>

              <button type="submit" class="submit-btn" id="submitBtn" disabled>
                <span>âœ“</span>
                <span>Confirmer mon inscription</span>
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Tab: CrÃ©er un Ã©vÃ©nement -->
      <div class="tab-content" id="create-tab">
        <div class="create-event-container">
          <!-- Carte interactive -->
          <div class="map-section">
            <h2>ğŸ“ Placer le point sur la carte</h2>
            <div class="info-box">
              ğŸ’¡ Cliquez sur la carte pour placer le marqueur Ã  l'endroit
              souhaitÃ©
            </div>
            <div id="createEventMap"></div>
          </div>

          <!-- Formulaire de crÃ©ation -->
          <div class="create-form-section">
            <h2>âœï¸ Informations de l'Ã©vÃ©nement</h2>

            <div
              class="location-display"
              id="locationDisplay"
              style="display: none"
            >
              <strong>ğŸ“ Localisation</strong>
              <div id="locationCoords"></div>
            </div>

            <form id="createEventForm">
              <div class="form-group">
                <label for="eventName"
                  >Nom du lieu <span class="required">*</span></label
                >
                <input
                  type="text"
                  id="eventName"
                  name="eventName"
                  required
                  placeholder="Ex: Plage de Trez-Hir"
                />
              </div>

              <div class="form-group">
                <label for="eventDate"
                  >Date et heure <span class="required">*</span></label
                >
                <input
                  type="datetime-local"
                  id="eventDate"
                  name="eventDate"
                  required
                />
              </div>

              <div class="form-group">
                <label for="eventDescription">Description</label>
                <textarea
                  id="eventDescription"
                  name="eventDescription"
                  placeholder="Type de dÃ©chets, Ã©tat du lieu..."
                ></textarea>
              </div>

              <button
                type="submit"
                class="submit-btn"
                id="createEventBtn"
                disabled
              >
                <span>âœ“</span>
                <span>CrÃ©er l'Ã©vÃ©nement</span>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- FOOTER -->
    <footer class="footer">Â© 2026 â€“ ZÃ©ro DÃ©chets en Rade</footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      let selectedEvent = null;
      let createEventMarker = null;
      let selectedLocation = null;

      // RÃ©cupÃ©rer les paramÃ¨tres de l'URL si on vient de la carte
      const urlParams = new URLSearchParams(window.location.search);
      const lieuFromUrl = urlParams.get("lieu");

      // Gestion des tabs
      const tabBtns = document.querySelectorAll(".tab-btn");
      const tabContents = document.querySelectorAll(".tab-content");

      tabBtns.forEach((btn) => {
        btn.addEventListener("click", function () {
          const targetTab = this.getAttribute("data-tab");

          // DÃ©sactiver tous les tabs
          tabBtns.forEach((b) => b.classList.remove("active"));
          tabContents.forEach((c) => c.classList.remove("active"));

          // Activer le tab sÃ©lectionnÃ©
          this.classList.add("active");
          document.getElementById(targetTab + "-tab").classList.add("active");

          // Initialiser la carte si on affiche l'onglet crÃ©er
          if (targetTab === "create" && !createEventMap) {
            initCreateEventMap();
          }
        });
      });

      // Gestion de la sÃ©lection des Ã©vÃ©nements
      const eventCards = document.querySelectorAll(".event-card");
      const submitBtn = document.getElementById("submitBtn");
      const selectedEventDisplay = document.getElementById(
        "selectedEventDisplay",
      );
      const selectedEventText = document.getElementById("selectedEventText");
      const infoBox = document.querySelector("#join-tab .info-box");
      const formSection = document.querySelector(".form-section");

      // Charger et afficher les Ã©vÃ©nements personnalisÃ©s
      function loadCustomEvents() {
        const customEvents = JSON.parse(
          localStorage.getItem("customEvents") || "[]",
        );
        const eventsSection = document.querySelector(".events-section");

        customEvents.forEach((event) => {
          // DÃ©terminer le badge d'urgence
          let urgenceClass = "green";
          let urgenceText = "Faible";
          if (event.nbSignalements > 10 && event.nbSignalements <= 20) {
            urgenceClass = "orange";
            urgenceText = "ModÃ©rÃ©";
          } else if (event.nbSignalements > 20) {
            urgenceClass = "red";
            urgenceText = "Urgent";
          }

          // CrÃ©er la carte de l'Ã©vÃ©nement
          const eventCard = document.createElement("div");
          eventCard.className = "event-card";
          eventCard.setAttribute("data-lieu", event.lieu);
          eventCard.setAttribute("data-date", event.date);
          eventCard.setAttribute("data-signalements", event.nbSignalements);

          eventCard.innerHTML = `
                <div class="event-header">
                    <div class="event-title">${event.lieu}</div>
                    <span class="urgence-badge ${urgenceClass}">${urgenceText}</span>
                </div>
                <div class="event-info">
                    <div>ğŸ“… ${event.date}</div>
                    <div>ğŸš¨ ${event.nbSignalements} signalements</div>
                    <div>ğŸ‘¥ 0 participants inscrits</div>
                    ${event.description ? `<div>ğŸ“ ${event.description}</div>` : ""}
                </div>
            `;

          // Ajouter l'Ã©vÃ©nement de clic
          eventCard.addEventListener("click", function () {
            selectEvent(this);
          });

          // Ajouter la carte Ã  la section
          eventsSection.appendChild(eventCard);
        });
      }

      // Charger les Ã©vÃ©nements personnalisÃ©s au chargement de la page
      loadCustomEvents();

      eventCards.forEach((card) => {
        // Si on vient de la carte, sÃ©lectionner l'Ã©vÃ©nement correspondant
        if (lieuFromUrl && card.getAttribute("data-lieu") === lieuFromUrl) {
          selectEvent(card);
        }

        card.addEventListener("click", function () {
          selectEvent(this);
        });
      });

      function selectEvent(card) {
        // Retirer la sÃ©lection prÃ©cÃ©dente
        eventCards.forEach((c) => c.classList.remove("selected"));

        // SÃ©lectionner la nouvelle carte
        card.classList.add("selected");

        // RÃ©cupÃ©rer les donnÃ©es
        const signalements = parseInt(card.getAttribute("data-signalements"));
        selectedEvent = {
          lieu: card.getAttribute("data-lieu"),
          date: card.getAttribute("data-date"),
          signalements: signalements,
        };

        // DÃ©terminer la couleur
        let colorClass = "green";
        if (signalements > 10 && signalements <= 20) {
          colorClass = "orange";
        } else if (signalements > 20) {
          colorClass = "red";
        }

        // Appliquer la couleur au formulaire
        formSection.style.borderLeft = `6px solid ${getColor(colorClass)}`;
        selectedEventDisplay.style.background = getBackgroundColor(colorClass);
        selectedEventDisplay.style.borderLeftColor = getColor(colorClass);

        // Changer la couleur du bouton
        submitBtn.style.background = getGradient(colorClass);

        // Afficher l'Ã©vÃ©nement sÃ©lectionnÃ©
        selectedEventText.innerHTML = `
            <strong>${selectedEvent.lieu}</strong><br>
            ğŸ“… ${selectedEvent.date}
        `;
        selectedEventDisplay.classList.add("show");
        infoBox.style.display = "none";

        // Activer le bouton
        submitBtn.disabled = false;

        // Scroll vers le formulaire sur mobile
        if (window.innerWidth <= 968) {
          document
            .querySelector(".form-section")
            .scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }

      function getColor(colorClass) {
        switch (colorClass) {
          case "green":
            return "#2e7d32";
          case "orange":
            return "#e67e22";
          case "red":
            return "#c62828";
          default:
            return "#2e7d32";
        }
      }

      function getBackgroundColor(colorClass) {
        switch (colorClass) {
          case "green":
            return "#e8f5e9";
          case "orange":
            return "#fff3e0";
          case "red":
            return "#ffebee";
          default:
            return "#e8f5e9";
        }
      }

      function getGradient(colorClass) {
        switch (colorClass) {
          case "green":
            return "linear-gradient(135deg, #4caf50, #2e7d32)";
          case "orange":
            return "linear-gradient(135deg, #ff9800, #e67e22)";
          case "red":
            return "linear-gradient(135deg, #f44336, #c62828)";
          default:
            return "linear-gradient(135deg, #4caf50, #2e7d32)";
        }
      }

      // Gestion du formulaire d'inscription
      document
        .getElementById("participationForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          if (!selectedEvent) {
            alert(
              "âš ï¸ Veuillez sÃ©lectionner une mission avant de vous inscrire.",
            );
            return;
          }

          const nom = document.getElementById("nom").value;
          const email = document.getElementById("email").value;

          alert(
            `âœ… Inscription confirmÃ©e !\n\nMission : ${selectedEvent.lieu}\nDate : ${selectedEvent.date}\n\nMerci ${nom}, vous recevrez un email de confirmation Ã  ${email}.`,
          );

          // Redirection
          setTimeout(() => {
            window.location.href = "Missions.html";
          }, 2000);
        });

      // Initialisation de la carte pour crÃ©er un Ã©vÃ©nement
      let createEventMap = null;

      function initCreateEventMap() {
        createEventMap = L.map("createEventMap").setView([48.38, -4.48], 12);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "Â© OpenStreetMap",
        }).addTo(createEventMap);

        // IcÃ´ne pour le nouveau marqueur
        const newMarkerIcon = new L.Icon({
          iconUrl:
            "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
          shadowUrl:
            "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
        });

        // Clic sur la carte pour placer le marqueur
        createEventMap.on("click", async function (e) {
          const lat = e.latlng.lat;
          const lng = e.latlng.lng;

          // Supprimer l'ancien marqueur s'il existe
          if (createEventMarker) {
            createEventMap.removeLayer(createEventMarker);
          }

          // Ajouter le nouveau marqueur
          createEventMarker = L.marker([lat, lng], { icon: newMarkerIcon })
            .addTo(createEventMap)
            .bindPopup("ğŸ“ Nouvel Ã©vÃ©nement")
            .openPopup();

          // Sauvegarder la localisation
          selectedLocation = { lat, lng };

          // Afficher les coordonnÃ©es
          document.getElementById("locationDisplay").style.display = "block";
          document.getElementById("locationCoords").innerHTML = `
                Latitude: ${lat.toFixed(6)}<br>
                Longitude: ${lng.toFixed(6)}
            `;

          // Activer le bouton de crÃ©ation
          document.getElementById("createEventBtn").disabled = false;

          // RÃ©cupÃ©rer l'adresse via gÃ©ocodage inversÃ©
          try {
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`,
            );
            const data = await response.json();
            if (data.display_name) {
              document.getElementById("locationCoords").innerHTML +=
                `<br><small>${data.display_name}</small>`;
            }
          } catch (error) {
            console.error("Erreur de gÃ©ocodage inversÃ©:", error);
          }
        });
      }

      // Gestion du formulaire de crÃ©ation d'Ã©vÃ©nement
      document
        .getElementById("createEventForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          if (!selectedLocation) {
            alert("âš ï¸ Veuillez placer un marqueur sur la carte.");
            return;
          }

          const eventName = document.getElementById("eventName").value;
          const eventDate = document.getElementById("eventDate").value;
          const eventDescription =
            document.getElementById("eventDescription").value;

          // Sauvegarder dans localStorage
          const newEvent = {
            lieu: eventName,
            lat: selectedLocation.lat,
            lng: selectedLocation.lng,
            nbSignalements: 1, // Commence Ã  1 signalement
            date: new Date(eventDate).toLocaleDateString("fr-FR"),
            description: eventDescription || "",
          };

          // DEBUG
          console.log("Nouvel Ã©vÃ©nement Ã  sauvegarder:", newEvent);

          // RÃ©cupÃ©rer les Ã©vÃ©nements existants
          let events = JSON.parse(localStorage.getItem("customEvents") || "[]");
          events.push(newEvent);
          localStorage.setItem("customEvents", JSON.stringify(events));

          // DEBUG
          console.log("Tous les Ã©vÃ©nements sauvegardÃ©s:", events);

          alert(
            `âœ… Ã‰vÃ©nement crÃ©Ã© avec succÃ¨s !\n\nLieu : ${eventName}\nCoordonnÃ©es : ${selectedLocation.lat.toFixed(6)}, ${selectedLocation.lng.toFixed(6)}\n\nL'Ã©vÃ©nement apparaÃ®tra sur la carte.`,
          );

          // Redirection vers la carte
          setTimeout(() => {
            window.location.href = "Missions.html";
          }, 2000);
        });
    </script>
  </body>
</html>
